<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Intent Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Literata:opsz,wght@7..72,500;7..72,700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="header">
        <div class="badge">Intent Planner</div>
        <h1>Question -> Intent JSON</h1>
        <p>Calls Gemini once and returns structured intent JSON only.</p>
        <p><a href="/">Back</a></p>
      </header>

      <section class="panel">
        <label for="question">Question</label>
        <textarea id="question" rows="3" placeholder="e.g. revenue last month by revenue type"></textarea>
        <div class="actions">
          <button id="run" type="button">Run</button>
          <span id="status">Idle</span>
        </div>
      </section>

      <section class="panel">
        <label>Raw LLM Output</label>
        <pre id="raw" class="code">Ready.</pre>
      </section>

      <section class="panel">
        <label>Intent JSON</label>
        <pre id="intent" class="code">{
  "entity": null,
  "metric": null,
  "aggregation": null,
  "time_period": null,
  "filters": [],
  "group_by": [],
  "order_by": null,
  "limit": null,
  "threshold": null,
  "presentation": null
}</pre>
      </section>
    </div>

    <script>
      const run = document.getElementById("run");
      const q = document.getElementById("question");
      const status = document.getElementById("status");
      const raw = document.getElementById("raw");
      const intent = document.getElementById("intent");

      async function runIntent() {
        const query = q.value.trim();
        if (!query) return;
        status.textContent = "Running...";
        raw.textContent = "Working...";
        intent.textContent = "Working...";
        try {
          const res = await fetch("/api/intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });
          const text = await res.text();
          let data = null;
          try {
            data = JSON.parse(text);
          } catch (e) {
            data = { error: "Server did not return JSON", detail: text };
          }
          if (!res.ok) {
            status.textContent = "Failed";
            raw.textContent = data.detail || data.error || "Error";
            intent.textContent = "Error";
            return;
          }
          status.textContent = "Done";
          raw.textContent = data.raw || "";
          intent.textContent = JSON.stringify(data.intent, null, 2);
        } catch (e) {
          status.textContent = "Failed";
          raw.textContent = String(e);
          intent.textContent = "Error";
        }
      }

      run.addEventListener("click", runIntent);
      q.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
          event.preventDefault();
          runIntent();
        }
      });
    </script>
  </body>
</html>
